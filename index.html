<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
</head>

<body style="overflow: hidden;">

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.3.3/pixi.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pixi-spine@2.1.9/bin/pixi-spine.min.js"></script>
<script src="pixi-filters.js"></script>
<input type="file" multiple="" autocomplete="off" onchange="handleFiles(this)">

<script type="text/javascript">

	var app = new PIXI.Application({
		autoDensity: true,
		sharedTicker: true,
		antialias: true,
		transparent: true,
		resolution: devicePixelRatio,
		width: innerWidth,
		height: innerHeight
	});

	document.body.appendChild(app.view);
	addAndStart('character', true)

	function addAndStart(name, start) {
		app.loader
	    .add(name, `${name}.json`)

	    if (!start) return;

	    app.loader
	    .load(function (loader, resources) {
	    	const spineData = resources[name].spineData;
			const spine = new PIXI.spine.Spine(spineData);


	    });

	}

	var rawSkeletonData;
	var rawAtlasData;


	function handleFiles(input) {
	  for (const file of input.files) {
	  	const reader = new FileReader();
	    reader.onload = (function() {
		  	if (file.name.endsWith('.json')) {
		  		rawSkeletonData = JSON.parse(reader.result)
		  	}
		  	if (file.name.endsWith('.atlas')) {
		  		rawAtlasData = reader.result
		  	}
		  	if (file.name.endsWith('.png')) {

		  		setTimeout(() => {
					var spineAtlas = new PIXI.spine.core.TextureAtlas(rawAtlasData, function(line, callback) {
					    // pass the image here.
					    callback(PIXI.BaseTexture.fromImage(reader.result));
					}); // specify path, image.png will be added automatically

					var spineAtlasLoader = new PIXI.spine.core.AtlasAttachmentLoader(spineAtlas)
					var spineJsonParser = new PIXI.spine.core.SkeletonJson(spineAtlasLoader);

					// in case if you want everything scaled up two times
					spineJsonParser.scale = 2.0; 

					var spineData = spineJsonParser.readSkeletonData(rawSkeletonData);

					// now we can create spine instance
					var spine = new PIXI.spine.Spine(spineData);
					app.stage.addChild(spine);
			        spine.position.x = app.renderer.width / 2
			        spine.position.y = app.renderer.height / 2
				    spine.visible = true
					spine.scale.set(0.5)
				    spine.state.clearListeners()
					spine.skeleton.setToSetupPose()
					
					spine.state.addListener({
			            event: (entry, event) => {
			       		  console.log(event.data.name)
			            }
			          })
					
					let i = 30;
					for (const anim of spineData.animations) {
						i+= 20
						var radio = document.createElement('input');
						radio.type = 'radio'
						radio.value = anim.name
						radio.id = anim.name
						radio.name = 'radio'
						document.body.appendChild(radio);

						radio.style = `position: absolute; top: ${i}px`

						var label = document.createElement('label');
						label.setAttribute('for', anim.name)
						label.innerHTML = anim.name
						label.style = `position: absolute; top: ${i}px; left: 40px`
						document.body.appendChild(label);
						radio.onchange = (event) => {
							spine.state.setAnimation(0, event.target.value , true)
							console.log(event.target.value)
						}

					}

					spine.state.setAnimation(0, spineData.animations[0].name , true)
			     
			        app.start();
		  		})


		  	}
	    });

	    if (file.name.endsWith('.png')) {
			reader.readAsDataURL(file);
	    } else {
	    	reader.readAsText(file);
	    }

	  }

	}


</script>
</body>
</html>